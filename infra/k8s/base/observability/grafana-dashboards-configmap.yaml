apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  labels:
    app: grafana
data:
  auth.json: |
    {
      "uid": "auth-observability",
      "title": "Auth Service Observability",
      "timezone": "browser",
      "schemaVersion": 38,
      "version": 1,
      "editable": true,
      "refresh": "30s",
      "time": { "from": "now-6h", "to": "now" },
      "timepicker": {
        "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m"]
      },
      "templating": {
        "list": [
          {
            "name": "DS_PROMETHEUS",
            "type": "datasource",
            "query": "prometheus",
            "current": { "text": "Prometheus", "value": "Prometheus" },
            "label": "Datasource"
          },
          {
            "name": "service",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
            "query": "label_values(http_requests_total, service)",
            "current": { "text": "auth", "value": "auth" },
            "includeAll": false,
            "refresh": 2,
            "label": "Service"
          }
        ]
      },
      "panels": [
        {
          "type": "timeseries",
          "title": "Request Volume by Path/Status",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (path, method, status) (rate(http_requests_total{service=~\"$service\"}[5m]))",
              "legendFormat": "{{method}} {{path}} ({{status}})"
            }
          ],
          "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
        },
        {
          "type": "timeseries",
          "title": "Requests by Status Code",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
          "fieldConfig": {
            "defaults": { "custom": { "stacking": { "mode": "normal" } } }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\"}[5m]))",
              "legendFormat": "{{status}}"
            }
          ]
        },
        {
          "type": "stat",
          "title": "5xx Error Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\",status=~\"5..\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "4xx Error Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\",status=~\"4..\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "Total Request Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(http_requests_total{service=~\"$service\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "Success Rate (%)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "100 * (sum(rate(http_requests_total{service=~\"$service\",status=~\"2..\"}[5m])) / sum(rate(http_requests_total{service=~\"$service\"}[5m])))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "timeseries",
          "title": "Request Latency Quantiles",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
          "targets": [
            {
              "refId": "P50",
              "expr": "histogram_quantile(0.50, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p50"
            },
            {
              "refId": "P95",
              "expr": "histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p95"
            },
            {
              "refId": "P99",
              "expr": "histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p99"
            }
          ],
          "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
        },
        {
          "type": "timeseries",
          "title": "Latency by Endpoint (p95)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le, path, method) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "{{method}} {{path}}"
            }
          ],
          "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
        },
        {
          "type": "stat",
          "title": "User Registrations (1h)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 8, "x": 0, "y": 20 },
          "targets": [
            {
              "refId": "Total",
              "expr": "sum(increase(auth_registrations_total{service=~\"$service\"}[1h]))",
              "legendFormat": "total"
            },
            {
              "refId": "Success",
              "expr": "sum(increase(auth_registrations_total{service=~\"$service\",result=\"success\"}[1h]))",
              "legendFormat": "success"
            },
            {
              "refId": "Failure",
              "expr": "sum(increase(auth_registrations_total{service=~\"$service\",result=\"failure\"}[1h]))",
              "legendFormat": "failure"
            }
          ],
          "options": {
            "orientation": "horizontal",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "timeseries",
          "title": "Registration Rate (users/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 16, "x": 8, "y": 20 },
          "targets": [
            {
              "refId": "Total",
              "expr": "sum by (service) (rate(auth_registrations_total{service=~\"$service\"}[5m]))",
              "legendFormat": "total"
            },
            {
              "refId": "Success",
              "expr": "sum by (service) (rate(auth_registrations_total{service=~\"$service\",result=\"success\"}[5m]))",
              "legendFormat": "success"
            },
            {
              "refId": "Failure",
              "expr": "sum by (service) (rate(auth_registrations_total{service=~\"$service\",result=\"failure\"}[5m]))",
              "legendFormat": "failure"
            }
          ],
          "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
        }
      ]
    }
  gateway.json: |
    {
      "uid": "gateway-observability",
      "title": "Gateway Service Observability",
      "timezone": "browser",
      "schemaVersion": 38,
      "version": 1,
      "editable": true,
      "refresh": "30s",
      "time": { "from": "now-6h", "to": "now" },
      "timepicker": {
        "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m"]
      },
      "templating": {
        "list": [
          {
            "name": "DS_PROMETHEUS",
            "type": "datasource",
            "query": "prometheus",
            "current": { "text": "Prometheus", "value": "Prometheus" },
            "label": "Datasource"
          },
          {
            "name": "service",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
            "query": "label_values(http_requests_total, service)",
            "current": { "text": "gateway", "value": "gateway" },
            "includeAll": false,
            "refresh": 2,
            "label": "Service"
          }
        ]
      },
      "panels": [
        {
          "type": "timeseries",
          "title": "Request Volume by Path/Status",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (path, method, status) (rate(http_requests_total{service=~\"$service\"}[5m]))",
              "legendFormat": "{{method}} {{path}} ({{status}})"
            }
          ],
          "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
        },
        {
          "type": "timeseries",
          "title": "Requests by Status Code",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
          "fieldConfig": {
            "defaults": { "custom": { "stacking": { "mode": "normal" } } }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\"}[5m]))",
              "legendFormat": "{{status}}"
            }
          ]
        },
        {
          "type": "stat",
          "title": "5xx Error Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\",status=~\"5..\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "4xx Error Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\",status=~\"4..\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "Total Request Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(http_requests_total{service=~\"$service\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "Success Rate (%)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "100 * (sum(rate(http_requests_total{service=~\"$service\",status=~\"2..\"}[5m])) / sum(rate(http_requests_total{service=~\"$service\"}[5m])))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "timeseries",
          "title": "Request Latency Quantiles",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
          "targets": [
            {
              "refId": "P50",
              "expr": "histogram_quantile(0.50, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p50"
            },
            {
              "refId": "P95",
              "expr": "histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p95"
            },
            {
              "refId": "P99",
              "expr": "histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p99"
            }
          ],
          "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
        },
        {
          "type": "timeseries",
          "title": "Latency by Endpoint (p95)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le, path, method) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "{{method}} {{path}}"
            }
          ],
          "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
        },
        {
          "type": "timeseries",
          "title": "Goroutines (gateway)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 6, "w": 6, "x": 0, "y": 20 },
          "targets": [
            {
              "refId": "A",
              "expr": "go_goroutines{job=\"gateway\"}",
              "legendFormat": "goroutines"
            }
          ],
          "options": {
            "legend": { "displayMode": "hidden", "placement": "bottom" }
          }
        },
        {
          "type": "timeseries",
          "title": "Heap Alloc (gateway)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 6, "w": 6, "x": 6, "y": 20 },
          "fieldConfig": {
            "defaults": { "unit": "bytes" },
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "expr": "go_memstats_heap_alloc_bytes{job=\"gateway\"}",
              "legendFormat": "heap alloc"
            }
          ],
          "options": {
            "legend": { "displayMode": "hidden", "placement": "bottom" }
          }
        },
        {
          "type": "timeseries",
          "title": "GC Pause (p95, gateway)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 6, "w": 6, "x": 12, "y": 20 },
          "fieldConfig": {
            "defaults": { "unit": "s" },
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le) (rate(go_gc_duration_seconds_bucket{job=\"gateway\"}[5m])))",
              "legendFormat": "gc p95"
            }
          ],
          "options": {
            "legend": { "displayMode": "hidden", "placement": "bottom" }
          }
        },
        {
          "type": "timeseries",
          "title": "CPU & RSS (gateway)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 6, "w": 6, "x": 18, "y": 20 },
          "fieldConfig": {
            "defaults": {},
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "cpu" },
                "properties": [{ "id": "unit", "value": "percent" }]
              },
              {
                "matcher": { "id": "byName", "options": "rss" },
                "properties": [{ "id": "unit", "value": "bytes" }]
              }
            ]
          },
          "targets": [
            {
              "refId": "CPU",
              "expr": "rate(process_cpu_seconds_total{job=\"gateway\"}[5m])",
              "legendFormat": "cpu"
            },
            {
              "refId": "RSS",
              "expr": "process_resident_memory_bytes{job=\"gateway\"}",
              "legendFormat": "rss"
            }
          ],
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom" }
          }
        }
      ]
    }
  infra-overview.json: |
    {
      "uid": "platform-infra-overview",
      "title": "Platform Infra & Prometheus Overview",
      "timezone": "browser",
      "schemaVersion": 38,
      "version": 1,
      "editable": true,
      "refresh": "30s",
      "time": { "from": "now-6h", "to": "now" },
      "timepicker": {
        "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m"]
      },
      "templating": {
        "list": [
          {
            "name": "DS_PROMETHEUS",
            "type": "datasource",
            "query": "prometheus",
            "current": { "text": "Prometheus", "value": "Prometheus" },
            "label": "Datasource"
          },
          {
            "name": "job",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
            "query": "label_values(up, job)",
            "current": { "text": "All", "value": "All" },
            "includeAll": true,
            "allValue": ".*",
            "refresh": 2,
            "label": "Job"
          }
        ]
      },
      "panels": [
        {
          "type": "stat",
          "title": "Targets Up",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(up)"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "bargauge",
          "title": "Target Health by Job",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 10, "x": 6, "y": 0 },
          "fieldConfig": {
            "defaults": {
              "min": 0,
              "max": 1,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": 0 },
                  { "color": "green", "value": 1 }
                ]
              }
            },
            "overrides": []
          },
          "options": {
            "displayMode": "basic",
            "orientation": "horizontal",
            "showUnfilled": true
          },
          "targets": [
            {
              "refId": "A",
              "expr": "avg by (job) (up)",
              "legendFormat": "{{job}}"
            }
          ]
        },
        {
          "type": "stat",
          "title": "Scrape Failures (Total)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 8, "x": 16, "y": 0 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(increase(scrape_duration_seconds[5m] > bool 0))"
            }
          ],
          "options": {
            "orientation": "horizontal",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "timeseries",
          "title": "Scrape Duration by Job",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 0, "y": 4 },
          "fieldConfig": {
            "defaults": { "unit": "s" },
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "expr": "max by (job) (scrape_duration_seconds)",
              "legendFormat": "{{job}}"
            }
          ],
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          }
        },
        {
          "type": "timeseries",
          "title": "Samples Scraped per Job",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 12, "y": 4 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (job) (rate(scrape_samples_scraped[5m]))",
              "legendFormat": "{{job}}"
            }
          ],
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          }
        },
        {
          "type": "timeseries",
          "title": "Prometheus HTTP Requests by Code",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 0, "y": 11 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (code) (rate(prometheus_http_requests_total[5m]))",
              "legendFormat": "{{code}}"
            }
          ],
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          }
        },
        {
          "type": "timeseries",
          "title": "Prometheus HTTP Request Duration (p95)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 12, "y": 11 },
          "fieldConfig": {
            "defaults": { "unit": "s" },
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le) (rate(prometheus_http_request_duration_seconds_bucket[5m])))",
              "legendFormat": "p95"
            }
          ],
          "options": {
            "legend": { "displayMode": "hidden", "placement": "bottom" },
            "tooltip": { "mode": "single", "sort": "none" }
          }
        },
        {
          "type": "timeseries",
          "title": "Prometheus TSDB Head Series",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 0, "y": 18 },
          "targets": [
            {
              "refId": "A",
              "expr": "prometheus_tsdb_head_series",
              "legendFormat": "head series"
            }
          ],
          "options": {
            "legend": { "displayMode": "hidden", "placement": "bottom" },
            "tooltip": { "mode": "single", "sort": "none" }
          }
        },
        {
          "type": "timeseries",
          "title": "Prometheus TSDB Storage Size",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 12, "y": 18 },
          "fieldConfig": {
            "defaults": { "unit": "bytes" },
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "expr": "prometheus_tsdb_storage_blocks_bytes",
              "legendFormat": "blocks bytes"
            }
          ],
          "options": {
            "legend": { "displayMode": "hidden", "placement": "bottom" },
            "tooltip": { "mode": "single", "sort": "none" }
          }
        },
        {
          "type": "timeseries",
          "title": "Go Goroutines by Job",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 0, "y": 25 },
          "targets": [
            {
              "refId": "A",
              "expr": "go_goroutines{job=~\"$job\"}",
              "legendFormat": "{{job}}"
            }
          ],
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          }
        },
        {
          "type": "timeseries",
          "title": "Go Heap Alloc by Job",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 12, "y": 25 },
          "fieldConfig": {
            "defaults": { "unit": "bytes" },
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "expr": "go_memstats_heap_alloc_bytes{job=~\"$job\"}",
              "legendFormat": "{{job}}"
            }
          ],
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          }
        },
        {
          "type": "timeseries",
          "title": "Go GC Duration p95 by Job",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 0, "y": 32 },
          "fieldConfig": {
            "defaults": { "unit": "s" },
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le, job) (rate(go_gc_duration_seconds_bucket{job=~\"$job\"}[5m])))",
              "legendFormat": "{{job}}"
            }
          ],
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          }
        },
        {
          "type": "timeseries",
          "title": "Process CPU & RSS by Job",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 7, "w": 12, "x": 12, "y": 32 },
          "fieldConfig": {
            "defaults": {},
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "cpu" },
                "properties": [{ "id": "unit", "value": "percent" }]
              },
              {
                "matcher": { "id": "byName", "options": "rss" },
                "properties": [{ "id": "unit", "value": "bytes" }]
              }
            ]
          },
          "targets": [
            {
              "refId": "CPU",
              "expr": "rate(process_cpu_seconds_total{job=~\"$job\"}[5m])",
              "legendFormat": "cpu {{job}}"
            },
            {
              "refId": "RSS",
              "expr": "process_resident_memory_bytes{job=~\"$job\"}",
              "legendFormat": "rss {{job}}"
            }
          ],
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          }
        }
      ]
    }
  keys.json: |
    {
      "uid": "keys-observability",
      "title": "Keys Service Observability",
      "timezone": "browser",
      "schemaVersion": 38,
      "version": 1,
      "editable": true,
      "refresh": "30s",
      "time": { "from": "now-6h", "to": "now" },
      "timepicker": {
        "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m"]
      },
      "templating": {
        "list": [
          {
            "name": "DS_PROMETHEUS",
            "type": "datasource",
            "query": "prometheus",
            "current": { "text": "Prometheus", "value": "Prometheus" },
            "label": "Datasource"
          },
          {
            "name": "service",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
            "query": "label_values(http_requests_total, service)",
            "current": { "text": "keys", "value": "keys" },
            "includeAll": false,
            "refresh": 2,
            "label": "Service"
          }
        ]
      },
      "panels": [
        {
          "type": "timeseries",
          "title": "Request Volume by Path/Status",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (path, method, status) (rate(http_requests_total{service=~\"$service\"}[5m]))",
              "legendFormat": "{{method}} {{path}} ({{status}})"
            }
          ],
          "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
        },
        {
          "type": "timeseries",
          "title": "Requests by Status Code",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
          "fieldConfig": {
            "defaults": { "custom": { "stacking": { "mode": "normal" } } }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\"}[5m]))",
              "legendFormat": "{{status}}"
            }
          ]
        },
        {
          "type": "stat",
          "title": "5xx Error Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\",status=~\"5..\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "4xx Error Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\",status=~\"4..\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "timeseries",
          "title": "Request Latency Quantiles",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
          "targets": [
            {
              "refId": "P50",
              "expr": "histogram_quantile(0.50, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p50"
            },
            {
              "refId": "P95",
              "expr": "histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p95"
            },
            {
              "refId": "P99",
              "expr": "histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p99"
            }
          ],
          "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
        },
        {
          "type": "timeseries",
          "title": "Latency by Endpoint (p95)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le, path, method) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "{{method}} {{path}}"
            }
          ],
          "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
        },
        {
          "type": "stat",
          "title": "Device Registrations (1h)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 8, "x": 0, "y": 20 },
          "targets": [
            {
              "refId": "Success",
              "expr": "increase(keys_device_registrations_total{service=~\"$service\",result=\"success\"}[1h])",
              "legendFormat": "success"
            },
            {
              "refId": "Failure",
              "expr": "increase(keys_device_registrations_total{service=~\"$service\",result=\"failure\"}[1h])",
              "legendFormat": "failure"
            }
          ],
          "options": {
            "orientation": "horizontal",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "PreKey Bundle Fetches (1h)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 8, "x": 8, "y": 20 },
          "targets": [
            {
              "refId": "Success",
              "expr": "increase(keys_prekey_bundles_fetched_total{service=~\"$service\",result=\"success\"}[1h])",
              "legendFormat": "success"
            },
            {
              "refId": "Failure",
              "expr": "increase(keys_prekey_bundles_fetched_total{service=~\"$service\",result=\"failure\"}[1h])",
              "legendFormat": "failure"
            }
          ],
          "options": {
            "orientation": "horizontal",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "Signed PreKey Rotations (1h)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 8, "x": 16, "y": 20 },
          "targets": [
            {
              "refId": "Success",
              "expr": "increase(keys_signed_prekeys_rotated_total{service=~\"$service\",result=\"success\"}[1h])",
              "legendFormat": "success"
            },
            {
              "refId": "Failure",
              "expr": "increase(keys_signed_prekeys_rotated_total{service=~\"$service\",result=\"failure\"}[1h])",
              "legendFormat": "failure"
            }
          ],
          "options": {
            "orientation": "horizontal",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        }
      ]
    }
  messages.json: |
    {
      "uid": "messages-observability",
      "title": "Messages Service Observability",
      "timezone": "browser",
      "schemaVersion": 38,
      "version": 1,
      "editable": true,
      "refresh": "30s",
      "time": { "from": "now-6h", "to": "now" },
      "timepicker": {
        "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m"]
      },
      "templating": {
        "list": [
          {
            "name": "DS_PROMETHEUS",
            "type": "datasource",
            "query": "prometheus",
            "current": { "text": "Prometheus", "value": "Prometheus" },
            "label": "Datasource"
          },
          {
            "name": "service",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
            "query": "label_values(http_requests_total, service)",
            "current": { "text": "messages", "value": "messages" },
            "includeAll": false,
            "refresh": 2,
            "label": "Service"
          }
        ]
      },
      "panels": [
        {
          "type": "timeseries",
          "title": "Request Volume by Path/Status",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (path, method, status) (rate(http_requests_total{service=~\"$service\"}[5m]))",
              "legendFormat": "{{method}} {{path}} ({{status}})"
            }
          ],
          "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
        },
        {
          "type": "timeseries",
          "title": "Requests by Status Code",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
          "fieldConfig": {
            "defaults": { "custom": { "stacking": { "mode": "normal" } } }
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\"}[5m]))",
              "legendFormat": "{{status}}"
            }
          ]
        },
        {
          "type": "stat",
          "title": "5xx Error Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\",status=~\"5..\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "4xx Error Rate (req/s)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 8 },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (status) (rate(http_requests_total{service=~\"$service\",status=~\"4..\"}[5m]))"
            }
          ],
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "timeseries",
          "title": "Request Latency Quantiles",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
          "targets": [
            {
              "refId": "P50",
              "expr": "histogram_quantile(0.50, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p50"
            },
            {
              "refId": "P95",
              "expr": "histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p95"
            },
            {
              "refId": "P99",
              "expr": "histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "p99"
            }
          ],
          "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
        },
        {
          "type": "timeseries",
          "title": "Latency by Endpoint (p95)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le, path, method) (rate(http_request_duration_seconds_bucket{service=~\"$service\"}[5m])))",
              "legendFormat": "{{method}} {{path}}"
            }
          ],
          "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
        },
        {
          "type": "stat",
          "title": "Messages Stored (1h)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 8, "x": 0, "y": 20 },
          "targets": [
            {
              "refId": "Total",
              "expr": "sum(increase(messages_stored_total{service=~\"$service\"}[1h]))",
              "legendFormat": "total"
            },
            {
              "refId": "1to1",
              "expr": "sum(increase(messages_stored_total{service=~\"$service\",chat_type=\"1to1\"}[1h]))",
              "legendFormat": "1:1"
            },
            {
              "refId": "Group",
              "expr": "sum(increase(messages_stored_total{service=~\"$service\",chat_type=\"group\"}[1h]))",
              "legendFormat": "group"
            }
          ],
          "options": {
            "orientation": "horizontal",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "Message Deliveries (1h)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 8, "x": 8, "y": 20 },
          "targets": [
            {
              "refId": "Delivered",
              "expr": "sum(increase(messages_deliveries_total{service=~\"$service\",result=\"delivered\"}[1h]))",
              "legendFormat": "delivered"
            },
            {
              "refId": "Failed",
              "expr": "sum(increase(messages_deliveries_total{service=~\"$service\",result=\"failed\"}[1h]))",
              "legendFormat": "failed"
            }
          ],
          "options": {
            "orientation": "horizontal",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        },
        {
          "type": "stat",
          "title": "Decryption Failures (1h)",
          "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
          "gridPos": { "h": 4, "w": 8, "x": 16, "y": 20 },
          "targets": [
            {
              "refId": "Failures",
              "expr": "sum(increase(messages_decryption_failures_total{service=~\"$service\"}[1h]))",
              "legendFormat": "failures"
            }
          ],
          "options": {
            "orientation": "horizontal",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          }
        }
      ]
    }
