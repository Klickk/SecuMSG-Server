name: Deploy (self-hosted)

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build & Publish Images"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
      
    permissions:
      contents: read
      packages: read

    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: [self-hosted]

    steps:
      - uses: actions/checkout@v4

      # ensure docker compose exists in runner container
      - name: Ensure docker compose plugin
        run: |
          if ! docker compose version >/dev/null 2>&1; then
            mkdir -p ~/.docker/cli-plugins
            curl -sSL https://github.com/docker/compose/releases/download/v2.29.0/docker-compose-linux-x86_64 \
              -o ~/.docker/cli-plugins/docker-compose
            chmod +x ~/.docker/cli-plugins/docker-compose
            docker compose version
          fi

      - name: Compute lowercase owner/repo
        run: |
          echo "OWNER_LC=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "REPO_LC=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Write .env.prod
        run: |
          mkdir -p .docker
          {
            echo "REGISTRY=ghcr.io"
            echo "OWNER=${{ env.OWNER_LC }}"
            echo "REPO=${{ env.REPO_LC }}"
            echo "TAG=latest"
            # Quote secrets so '#' and spaces can't break parsing
            echo "POSTGRES_PASSWORD=\"${{ secrets.PROD_POSTGRES_PASSWORD }}\""
            echo "SIGNING_KEY=\"${{ secrets.PROD_SIGNING_KEY }}\""
            echo "CORS_ORIGINS=\"${{ vars.CORS_ORIGINS }}\""
          } > .docker/.env.prod

      - name: Show env file (sanitized)
        run: sed -E 's/=(.*)/=*** /' .docker/.env.prod

      - name: Login GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Pull & start stack
        run: |
          docker compose --project-directory . -f .docker/docker-compose.prod.yml --env-file .docker/.env.prod pull
          docker compose --project-directory . -f .docker/docker-compose.prod.yml --env-file .docker/.env.prod up -d

      # If anything fails above, dump logs
      - name: Dump compose state on failure
        if: failure()
        run: |
          docker compose --project-directory . -f .docker/docker-compose.prod.yml --env-file .docker/.env.prod ps
          docker compose --project-directory . -f .docker/docker-compose.prod.yml --env-file .docker/.env.prod logs --no-color --tail=200 || true
      
      - name: Show running containers
        run: docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}'
